<script>
    // --- FIREBASE AYARLARI (SENİN BİLGİLERİNLE DOLDURULDU) ---
    const firebaseConfig = {
        apiKey: "AIzaSyCiBt7rhXk1Q5ng9HoNt9fgH1PEpqlYivA",
        authDomain: "taktikfutbol.firebaseapp.com",
        databaseURL: "https://taktikfutbol-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "taktikfutbol",
        storageBucket: "taktikfutbol.firebasestorage.app",
        messagingSenderId: "56995748886",
        appId: "1:56995748886:web:5b7c4ece9c5f430a92a937",
        measurementId: "G-RCCP6VTXSL"
    };

    // Firebase Başlatma
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- DEĞİŞKENLER ---
    let myRole = null;
    let currentRoom = null;
    let isHost = false;
    let gameListener = null;

    // --- LOBİ İŞLEMLERİ ---
    function showHostMenu() {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('host-menu').classList.remove('hidden');
    }
    function showJoinMenu() {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('join-menu').classList.remove('hidden');
    }
    function resetLobby() { location.reload(); }

    function createRoom(role) {
        myRole = role; isHost = true;
        // Rastgele 5 haneli kod üret
        const roomId = Math.random().toString(36).substring(2, 7).toUpperCase();
        currentRoom = roomId;

        // Veritabanına odayı yaz
        db.ref('rooms/' + roomId).set({
            hostRole: role,
            status: 'waiting',
            createdAt: Date.now()
        });

        // Guest'in katılmasını dinle
        db.ref('rooms/' + roomId + '/status').on('value', (snapshot) => {
            if (snapshot.val() === 'joined') {
                // Guest katıldı, senaryo seçimine geç
                document.getElementById('lobby-screen').classList.add('hidden');
                document.getElementById('scenario-screen').classList.remove('hidden');
            }
        });

        document.getElementById('host-menu').classList.add('hidden');
        document.getElementById('waiting-panel').classList.remove('hidden');
        document.getElementById('room-display-code').innerText = "KOD: " + roomId;
    }

    function joinRoom() {
        const code = document.getElementById('room-code-input').value.toUpperCase().trim();
        if(!code) return alert("Kod girin!");
        currentRoom = code;
        isHost = false;

        // Odayı kontrol et
        db.ref('rooms/' + code).get().then((snapshot) => {
            if (snapshot.exists()) {
                const roomData = snapshot.val();
                // Host'un tersi rolü al
                myRole = (roomData.hostRole === 'atk') ? 'def' : 'atk';
                
                // Durumu güncelle
                db.ref('rooms/' + code).update({ status: 'joined' });
                
                // Oyunu dinlemeye başla
                startGameListener();

                document.getElementById('lobby-screen').classList.add('hidden');
                showWait("Ev sahibi maçı kuruyor...");
            } else {
                alert("Böyle bir oda yok!");
            }
        }).catch((error) => {
            alert("Bağlantı hatası: " + error.message);
        });
    }

    // --- OYUN SENKRONİZASYONU (ALTIN KISIM) ---
    
    function startGame() {
        // Sadece Host çağırır
        const s = SCENARIOS[scenIdx];
        gameState.players = [];
        s.atk.forEach((p,i)=>gameState.players.push({id:`a${i}`, team:'atk', r:p.r, c:p.c, label:p.l}));
        s.def.forEach((p,i)=>gameState.players.push({id:`d${i}`, team:'def', r:p.r, c:p.c, label:p.l}));
        gameState.ballOwnerId = gameState.players[0].id;
        gameState.phase = 'ATTACK_PLAN';
        
        // Veritabanına başlangıç durumunu yaz
        updateDB('START');
        
        document.getElementById('scenario-screen').classList.add('hidden');
        startGameListener(); // Host da dinlemeye başlasın
    }

    function updateDB(type, title = "", desc = "") {
        db.ref('rooms/' + currentRoom + '/game').set({
            state: gameState,
            lastAction: type, // START, MOVED, RESULT, NEXT
            title: title,
            desc: desc,
            timestamp: Date.now()
        });
    }

    function startGameListener() {
        // Veritabanındaki 'game' her değiştiğinde bu çalışır
        db.ref('rooms/' + currentRoom + '/game').on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            gameState = data.state; // State'i güncelle

            if (data.lastAction === 'START' || data.lastAction === 'NEXT') {
                hideWait(); 
                document.getElementById('result-screen').classList.add('hidden');
                render(); updateUI();
            }
            else if (data.lastAction === 'MOVED') {
                hideWait(); render(); updateUI();
            }
            else if (data.lastAction === 'RESULT') {
                showResult(data.title, data.desc);
                render();
            }
        });
    }

    // --- OYUN MANTIĞI (AYNI KORUNDU) ---
    const ROWS = 7; const COLS = 5; let scenIdx = 0;
    const SCENARIOS = [
        { atk: [{r:6,c:2,l:'10'}, {r:5,c:1,l:'8'}, {r:5,c:3,l:'7'}, {r:4,c:2,l:'9'}], def: [{r:0,c:2,l:'GK'}, {r:2,c:1,l:'4'}, {r:2,c:3,l:'5'}, {r:3,c:2,l:'6'}] },
        { atk: [{r:6,c:2,l:'6'}, {r:4,c:0,l:'11'}, {r:4,c:4,l:'7'}, {r:5,c:2,l:'10'}], def: [{r:0,c:2,l:'GK'}, {r:2,c:0,l:'2'}, {r:2,c:4,l:'3'}, {r:2,c:2,l:'4'}] },
        { atk: [{r:6,c:1,l:'4'}, {r:6,c:3,l:'5'}, {r:5,c:2,l:'8'}, {r:2,c:2,l:'9'}], def: [{r:0,c:2,l:'GK'}, {r:1,c:1,l:'4'}, {r:1,c:3,l:'5'}, {r:3,c:2,l:'6'}] },
        { atk: [{r:4,c:2,l:'9'}, {r:5,c:1,l:'11'}, {r:5,c:3,l:'7'}, {r:6,c:2,l:'GK'}], def: [{r:0,c:2,l:'GK'}, {r:1,c:1,l:'2'}, {r:1,c:2,l:'4'}, {r:1,c:3,l:'5'}] }
    ];
    let gameState = { phase: 'INIT', players: [], ballOwnerId: null, selectedUnit: null, moves: { atk: null, def: null } };

    const pitch = document.getElementById('pitch');
    const statusText = document.getElementById('status-text');

    function selectScen(i, el) { scenIdx=i; document.querySelectorAll('.scenario-opt').forEach(e=>e.classList.remove('active')); el.classList.add('active'); }
    
    function showWait(m) { document.getElementById('wait-msg').innerText = m; document.getElementById('wait-screen').classList.remove('hidden'); }
    function hideWait() { document.getElementById('wait-screen').classList.add('hidden'); }
    
    function updateUI() {
        const status = document.getElementById('status-text');
        if(gameState.phase === 'ATTACK_PLAN') {
            if(myRole === 'atk') { status.innerText = "HÜCUM SIRA SENDE"; status.style.color = "#fbbf24"; }
            else { status.innerText = "RAKİP HÜCUM YAPIYOR"; status.style.color = "#fff"; showWait("Rakip düşünüyor..."); }
        } 
        else if(gameState.phase === 'DEFENSE_PLAN' || gameState.phase === 'WAIT_DEF') {
            if(gameState.phase === 'WAIT_DEF') gameState.phase = 'DEFENSE_PLAN';
            if(myRole === 'def') { status.innerText = "SAVUNMA SIRA SENDE"; status.style.color = "#60a5fa"; }
            else { status.innerText = "RAKİP SAVUNMA YAPIYOR"; status.style.color = "#fff"; showWait("Rakip blokluyor..."); }
        }
    }

    function showResult(t, d) {
        document.getElementById('res-title').innerText = t;
        document.getElementById('res-desc').innerHTML = d;
        document.getElementById('result-screen').classList.remove('hidden');
        hideWait();
    }

    function nextTurn() {
        if(!isHost) { showWait("Host bekleniyor..."); document.getElementById('result-screen').classList.add('hidden'); return; }
        gameState.phase = 'ATTACK_PLAN'; gameState.selectedUnit = null; gameState.moves = {atk:null, def:null};
        updateDB('NEXT');
    }

    // --- RENDER & INPUT ---
    function render() {
        pitch.innerHTML = '';
        for(let r=0; r<ROWS; r++) {
            for(let c=0; c<COLS; c++) {
                const d = document.createElement('div'); d.className='cell'; d.dataset.r=r; d.dataset.c=c;
                const p = gameState.players.find(x=>x.r===r && x.c===c);
                if(p) {
                    const t = document.createElement('div'); t.className=`token ${p.team}`; t.innerText=p.label;
                    if(p.id===gameState.ballOwnerId) { t.innerHTML+=`<div class="ball"></div>`; t.style.borderColor="#fbbf24"; t.style.zIndex="10"; }
                    if(gameState.selectedUnit===p.id) t.classList.add('selected'); d.appendChild(t);
                }
                if(myRole==='atk' && gameState.phase==='ATTACK_PLAN' && gameState.selectedUnit===gameState.ballOwnerId) {
                    const o = gameState.players.find(x=>x.id===gameState.ballOwnerId);
                    if(p && p.team==='atk' && p.id!==o.id) addMark(d,'m-pass');
                    if(!p && Math.abs(o.r-r)<=1 && Math.abs(o.c-c)<=1) addMark(d,'m-move');
                }
                if(myRole==='def' && gameState.phase==='DEFENSE_PLAN' && gameState.selectedUnit) {
                    const df = gameState.players.find(x=>x.id===gameState.selectedUnit);
                    if(df && df.team==='def' && Math.abs(df.r-r)<=1 && Math.abs(df.c-c)<=1) addMark(d,'m-block');
                }
                d.onclick = () => handleInp(r,c,p); pitch.appendChild(d);
            }
        }
    }
    function addMark(el, type) { const m=document.createElement('div'); m.className=`marker ${type}`; el.appendChild(m); }

    function handleInp(r,c,p) {
        if((myRole==='atk' && gameState.phase!=='ATTACK_PLAN') || (myRole==='def' && gameState.phase!=='DEFENSE_PLAN')) return;
        
        if(myRole==='atk') {
            if(p && p.id===gameState.ballOwnerId) { gameState.selectedUnit=p.id; render(); return; }
            if(gameState.selectedUnit===gameState.ballOwnerId) {
                const o = gameState.players.find(x=>x.id===gameState.ballOwnerId);
                if(p && p.team==='atk' && p.id!==o.id) { gameState.moves.atk={type:'PASS', r:r, c:c, targetId:p.id, actorId:o.id}; commit(); }
                else if(!p && Math.abs(o.r-r)<=1 && Math.abs(o.c-c)<=1) { gameState.moves.atk={type:'MOVE', r:r, c:c, actorId:o.id}; commit(); }
            }
        } else {
            if(p && p.team==='def') { gameState.selectedUnit=p.id; render(); return; }
            if(gameState.selectedUnit) {
                const df = gameState.players.find(x=>x.id===gameState.selectedUnit);
                if(Math.abs(df.r-r)<=1 && Math.abs(df.c-c)<=1) { gameState.moves.def={r:r, c:c, actorId:df.id}; commit(); }
            }
        }
    }

    function commit() {
        if(myRole==='atk') { gameState.phase='WAIT_DEF'; updateDB('MOVED'); }
        else { 
            gameState.phase='RESOLVE'; 
            updateDB('MOVED'); 
            if(isHost) setTimeout(resolveTurn, 500);
        }
    }

    // HOST TARAFI HESAPLAMA
    function resolveTurn() {
        const am = gameState.moves.atk; const dm = gameState.moves.def;
        if(!am || !dm) return; 

        const ad = gameState.players.find(x=>x.id===dm.actorId);
        const startR = ad.r; const startC = ad.c;
        ad.r = dm.r; ad.c = dm.c; 

        const sAtk = gameState.players.find(x=>x.team==='atk' && x.r===dm.r && x.c===dm.c && x.id!==gameState.ballOwnerId);
        let msg = "";
        if(sAtk) { sAtk.r=startR; sAtk.c=startC; msg="<br>(Yer Değişimi!)"; }

        const blocked = (am.r===dm.r && am.c===dm.c);
        let t="", d="", over=false;

        if(blocked) { t="TOP KAYBI!"; d="Blok başarılı."+msg; over=true; }
        else {
            if(am.type==='PASS') { gameState.ballOwnerId=am.targetId; t="PAS BAŞARILI"; d="Atak devam."+msg; }
            else { const ap=gameState.players.find(x=>x.id===am.actorId); ap.r=am.r; ap.c=am.c; t="ÇALIM BAŞARILI"; d="Boş alan."+msg; }
            if(am.r===0) { t="GOL!"; d="Top ağlarda!"; over=true; }
        }

        updateDB('RESULT', t, d);
    }

</script>
