<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TACTICAL MASTER: ELITE SQUAD</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        /* --- GÖRSEL TASARIM (AYNI) --- */
        :root { --grass-light: #4b8b3b; --grass-dark: #3a702e; --line-white: rgba(255,255,255,0.85); --net-pattern: rgba(255,255,255,0.15); --kit-atk-primary: #d32f2f; --kit-atk-secondary: #b71c1c; --kit-def-primary: #1976d2; --kit-def-secondary: #0d47a1; --ui-bg: #1e293b; --ui-border: #334155; --gold: #fbbf24; }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; min-height: 100vh; background: #111 radial-gradient(circle at 50% 30%, #2c3e50 0%, #000000 90%) fixed; color: #fff; font-family: 'Rajdhani', sans-serif; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        header { width: 100%; padding: 15px; text-align: center; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); z-index: 10; position: relative; flex-shrink: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        h1 { margin: 0; font-size: 2.2rem; letter-spacing: 4px; background: linear-gradient(to right, #fff, #ccc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; filter: drop-shadow(0 0 5px rgba(255,255,255,0.3)); }
        .status-bar { display: inline-block; margin-top: 8px; padding: 6px 20px; border-radius: 50px; background: rgba(0,0,0,0.5); font-size: 1.1rem; color: var(--gold); border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(5px); }
        .player-badge { position: absolute; right: 20px; top: 20px; background: #333; padding: 5px 10px; border-radius: 4px; font-size: 0.9rem; border: 1px solid #555; }
        
        #game-stage { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; padding: 40px 20px; perspective: 1000px; }
        .pitch { display: grid; grid-template-columns: repeat(5, 75px); grid-template-rows: repeat(7, 65px); background-color: var(--grass-light); background-image: repeating-linear-gradient(0deg, transparent, transparent 65px, rgba(0,0,0,0.1) 65px, rgba(0,0,0,0.1) 130px); border: 15px solid #ddd; border-radius: 4px; box-shadow: 0 20px 50px rgba(0,0,0,0.8), inset 0 0 50px rgba(0,0,0,0.2); position: relative; transform-style: preserve-3d; transform: rotateX(20deg); }
        .pitch::after { content: ''; position: absolute; inset: 5px; border: 2px solid var(--line-white); pointer-events: none; }
        .cell { position: relative; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: inset 0 0 0 0.5px rgba(255,255,255,0.1); }
        .cell[data-r="0"] { background-image: linear-gradient(var(--net-pattern) 1px, transparent 1px), linear-gradient(90deg, var(--net-pattern) 1px, transparent 1px); background-size: 8px 8px; background-color: rgba(0,0,0,0.2); box-shadow: inset 0 -3px 0 var(--line-white); }
        .cell[data-r="3"] { border-bottom: 2px solid rgba(255,255,255,0.6); }
        .token { width: 48px; height: 48px; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: 800; font-size: 18px; color: white; position: relative; z-index: 5; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); background-size: 100% 100%; box-shadow: 0 5px 10px rgba(0,0,0,0.4); border: 2px solid #fff; }
        .role-tag { font-size: 9px; font-weight: normal; margin-top: -4px; opacity: 0.9; }
        .atk { background: repeating-linear-gradient(45deg, var(--kit-atk-primary), var(--kit-atk-primary) 10px, var(--kit-atk-secondary) 10px, var(--kit-atk-secondary) 20px); }
        .def { background: radial-gradient(circle at 30% 30%, var(--kit-def-primary), var(--kit-def-secondary)); }
        .ball { position: absolute; width: 20px; height: 20px; border-radius: 50%; top: -8px; right: -8px; z-index: 15; background: #fff; box-shadow: 0 5px 10px rgba(0,0,0,0.5); border: 1px solid #ccc; animation: floatBall 2s infinite ease-in-out; }
        @keyframes floatBall { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-2px);} }
        .selected { transform: scale(1.2) translateY(-5px); box-shadow: 0 15px 25px rgba(0,0,0,0.6); border-color: var(--gold); z-index: 20; }
        
        .marker { position: absolute; width: 100%; height: 100%; pointer-events: none; display: flex; justify-content: center; align-items: center; }
        .m-move::after { content: ''; width: 20px; height: 20px; background: rgba(251, 191, 36, 0.4); border: 2px solid rgba(251, 191, 36, 0.8); border-radius: 50%; animation: pulse 1s infinite; }
        .m-pass::after { content: ''; width: 50px; height: 50px; border: 2px dashed rgba(74, 222, 128, 0.8); border-radius: 50%; animation: spinSlow 4s infinite linear; }
        .m-block { background: repeating-linear-gradient(45deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.2) 10px, transparent 10px, transparent 20px); border: 2px solid rgba(239, 68, 68, 0.6); }
        
        @keyframes pulse { 0% {transform: scale(0.8); opacity: 1;} 100% {transform: scale(1.2); opacity: 0;} }
        @keyframes spinSlow { 100% {transform: rotate(360deg);} }
        
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; transition: opacity 0.3s; }
        .hidden { opacity: 0; pointer-events: none; }
        .card { background: var(--ui-bg); padding: 40px; border-radius: 16px; border: 1px solid var(--ui-border); text-align: center; width: 90%; max-width: 500px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        
        .btn { background: linear-gradient(to bottom, #2563eb, #1d4ed8); border: none; border-bottom: 4px solid #1e40af; padding: 16px 32px; color: white; font-family: 'Rajdhani', sans-serif; font-size: 1.2rem; font-weight: 700; border-radius: 8px; cursor: pointer; margin-top: 20px; text-transform: uppercase; letter-spacing: 1px; width: 100%; transition: all 0.1s; }
        .btn:active { transform: translateY(2px); border-bottom-width: 2px; }
        .btn-secondary { background: #475569; border-color: #334155; margin-top: 10px; }
        .btn-danger { background: linear-gradient(to bottom, #dc2626, #b91c1c); border-color: #991b1b; }
        .btn-atk { background: linear-gradient(to bottom, #d32f2f, #b71c1c); border-color: #7f1d1d; } 
        .btn-def { background: linear-gradient(to bottom, #1976d2, #0d47a1); border-color: #1e3a8a; }
        .btn-gold { background: linear-gradient(to bottom, #fbbf24, #d97706); border-color: #b45309; color: #000; }

        .input-box { width: 100%; padding: 15px; margin: 10px 0; background: #0f172a; border: 1px solid #334155; color: white; font-size: 1.5rem; text-align: center; border-radius: 8px; letter-spacing: 3px; }
        .scenario-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .scenario-opt { background: #334155; border: 2px solid transparent; padding: 15px; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: left; }
        .scenario-opt:hover { background: #475569; }
        .scenario-opt.active { border-color: var(--gold); background: #1e293b; box-shadow: 0 0 15px rgba(251, 191, 36, 0.2); }
        
        .action-panel { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; display: flex; gap: 10px; z-index: 50; }
        .shot-btn { flex: 1; padding: 20px; font-size: 1.5rem; background: linear-gradient(to bottom, #dc2626, #991b1b); border: 2px solid #fff; box-shadow: 0 0 20px rgba(220, 38, 38, 0.8); animation: pulse 1s infinite; display: none; }
        .shot-btn.visible { display: block; }

        .lobby-code { font-size: 2em; color: var(--gold); letter-spacing: 3px; font-weight: bold; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; user-select: text; cursor: pointer; }
        .waiting-spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--gold); border-radius: 50%; animation: spin 1s infinite linear; margin: 20px auto; }
        @keyframes spin { to {transform: rotate(360deg);} }
        #sys-log { position: fixed; bottom: 5px; left: 5px; color: #0f0; font-family: monospace; font-size: 10px; background: rgba(0,0,0,0.8); padding: 5px; max-width: 300px; pointer-events: none; z-index: 9999; }
        #wait-screen.overlay { inset: auto; bottom: 0; left: 0; right: 0; height: auto; background: transparent; justify-content: flex-end; pointer-events: none; }
        #wait-screen .card { width: 100%; max-width: 100%; border-radius: 20px 20px 0 0; background: rgba(30, 41, 59, 0.95); border-bottom: none; padding: 20px; display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 20px; backdrop-filter: blur(10px); border-top: 2px solid var(--gold); animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
    </style>
</head>
<body>

    <header>
        <h1>TACTICAL MASTER</h1>
        <div class="status-bar" id="status-text">BAĞLANTI BEKLENİYOR</div>
        <div class="player-badge" id="role-badge">SEYİRCİ</div>
    </header>

    <div id="game-stage"><div class="pitch" id="pitch"></div></div>
    <div id="sys-log">Sistem başlatılıyor...</div>

    <div class="action-panel">
        <button id="btn-shoot-trigger" class="btn shot-btn" onclick="openShotMenu()">⚡ ŞUT ÇEK ⚡</button>
    </div>

    <div id="lobby-screen" class="overlay">
        <div class="card">
            <h2 style="color:var(--gold);">ONLINE LOBİ</h2>
            <div id="lobby-menu">
                <button class="btn" onclick="showHostMenu()">OYUN KUR (HOST)</button>
                <button class="btn btn-secondary" onclick="showJoinMenu()">OYUNA KATIL (GUEST)</button>
            </div>
            <div id="team-select-panel" class="hidden">
                <h3>HANGİ TAKIM?</h3>
                <button class="btn btn-atk" onclick="createRoom('atk')">HÜCUM (KIRMIZI)</button>
                <button class="btn btn-def" onclick="createRoom('def')">SAVUNMA (MAVİ)</button>
                <button class="btn btn-secondary" onclick="resetLobby()">İPTAL</button>
            </div>
            <div id="host-panel" class="hidden">
                <p>Oda Kodun:</p>
                <div class="lobby-code" id="my-id-display" onclick="copyId()">...</div>
                <p style="font-size:0.9em; color:#aaa;">Kodu arkadaşına gönder.</p>
                <div class="waiting-spinner"></div>
                <button class="btn btn-secondary" onclick="resetLobby()">GERİ</button>
            </div>
            <div id="join-panel" class="hidden">
                <p>Oda Kodunu Gir:</p>
                <input type="text" id="room-code-input" class="input-box" placeholder="XXXXX">
                <button class="btn" id="btn-join" onclick="joinRoom()">BAĞLAN</button>
                <button class="btn btn-secondary" onclick="resetLobby()">GERİ</button>
            </div>
        </div>
    </div>

    <div id="scenario-screen" class="overlay hidden">
        <div class="card">
            <h2 style="color:var(--gold);">DİZİLİŞ SEÇ</h2>
            <div class="scenario-grid">
                <div class="scenario-opt active" onclick="selectScen(0, this)"><div class="scenario-title">4'LÜ HÜCUM</div><div class="scenario-sub">ST - 10 - LW - RW</div></div>
            </div>
            <button class="btn" onclick="startGame()">MAÇI BAŞLAT</button>
        </div>
    </div>

    <div id="wait-screen" class="overlay hidden">
        <div class="card">
            <div class="waiting-spinner"></div>
            <h2 style="color:var(--gold);" id="wait-msg">RAKİP BEKLENİYOR...</h2>
        </div>
    </div>

    <div id="shot-screen" class="overlay hidden">
        <div class="card">
            <h2 id="shot-title" style="color:var(--gold);">ŞUT ÇEK!</h2>
            <p id="shot-desc">Topu hangi köşeye göndereceksin?</p>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-secondary" onclick="confirmShot('L')">⬅️ SOL KÖŞE</button>
                <button class="btn btn-secondary" onclick="confirmShot('R')">SAĞ KÖŞE ➡️</button>
            </div>
        </div>
    </div>

    <div id="result-screen" class="overlay hidden"><div class="card"><h2 id="result-title">SONUÇ</h2><div style="height:4px; width:60px; background:var(--gold); margin:20px auto;"></div><p id="result-desc"></p><button class="btn" id="result-btn" onclick="closeResult()">TAMAM</button></div></div>

    <script>
        // --- MQTT SİSTEMİ (Standart) ---
        let client = null; let myRole = null; let currentRoom = null; let isHost = false; let connected = false;
        const BROKER_URL = 'wss://broker.emqx.io:8084/mqtt';

        function log(m) { document.getElementById('sys-log').innerText = m; }
        const el=(id)=>document.getElementById(id);
        const show=(id)=>el(id).classList.remove('hidden');
        const hide=(id)=>el(id).classList.add('hidden');

        function showHostMenu() { hide('lobby-menu'); show('team-select-panel'); }
        function showJoinMenu() { hide('lobby-menu'); show('join-panel'); }
        function resetLobby() { location.reload(); }

        function createRoom(role) {
            myRole = role; isHost = true;
            const roomId = Math.random().toString(36).substring(2, 7).toUpperCase();
            currentRoom = roomId;
            el('my-id-display').innerText = roomId;
            hide('team-select-panel'); show('host-panel');
            connectMQTT(roomId);
        }

        function joinRoom() {
            const code = el('room-code-input').value.toUpperCase().trim();
            if(!code) return alert("Kod gir!");
            currentRoom = code; isHost = false;
            el('btn-join').innerText = "BAĞLANIYOR...";
            connectMQTT(code);
        }

        function connectMQTT(roomId) {
            log("Bağlanıyor...");
            const clientId = 'tactical_' + Math.random().toString(16).substr(2, 8);
            client = mqtt.connect(BROKER_URL, { clientId: clientId });

            client.on('connect', () => {
                log("Bağlandı: " + roomId);
                connected = true;
                client.subscribe(`tactic/${roomId}`, (err) => {
                    if(!err && !isHost) sendData({ type: 'JOIN_REQUEST' });
                });
            });

            client.on('message', (topic, message) => {
                handleData(JSON.parse(message.toString()));
            });
        }

        function sendData(payload) {
            if(client && connected) {
                payload.sender = isHost ? 'HOST' : 'GUEST';
                client.publish(`tactic/${currentRoom}`, JSON.stringify(payload));
            }
        }

        function handleData(data) {
            if (isHost && data.sender === 'HOST') return;
            if (!isHost && data.sender === 'GUEST') return;

            switch(data.type) {
                case 'JOIN_REQUEST':
                    if(isHost) {
                        const guestRole = (myRole === 'atk') ? 'def' : 'atk';
                        sendData({ type: 'JOIN_ACCEPT', role: guestRole });
                        hide('lobby-screen'); show('scenario-screen');
                        updateRoleUI();
                    }
                    break;
                case 'JOIN_ACCEPT':
                    if(!isHost) {
                        myRole = data.role;
                        updateRoleUI();
                        hide('lobby-screen'); showWait("Ev sahibi maçı kuruyor...");
                    }
                    break;
                case 'START':
                    gameState = data.state;
                    if(!isHost) { hideWait(); hide('result-screen'); render(); updateUI(); }
                    break;
                case 'MOVED':
                    gameState = data.state;
                    hideWait(); render(); updateUI();
                    if(isHost && gameState.phase === 'RESOLVE') { setTimeout(resolveTurn, 500); }
                    break;
                case 'RESULT':
                    gameState = data.state;
                    showResult(data.title, data.desc); render();
                    break;
                case 'NEXT':
                    gameState = data.state;
                    hideWait(); hide('result-screen'); render(); updateUI();
                    break;
            }
        }

        function updateRoleUI() {
            const b = el('role-badge');
            if(myRole === 'atk') { b.innerText = "HÜCUM (KIRMIZI)"; b.style.color = "#ff8a8a"; }
            else { b.innerText = "SAVUNMA (MAVİ)"; b.style.color = "#8ab4ff"; }
        }

        function copyId() { navigator.clipboard.writeText(el('my-id-display').innerText); alert("Kopyalandı!"); }

        // --- OYUN MOTORU & YENİ KADRO ---
        const ROWS = 7; const COLS = 5; let scenIdx = 0;
        
        // 4 ATK (ST, 10, LW, RW) vs 4 DEF (GK, 3xDef)
        const SCENARIOS = [
            { 
                atk: [
                    {r:5,c:2,l:'9', role:'ST'},   // Santrafor
                    {r:6,c:2,l:'10', role:'10'},  // On Numara
                    {r:5,c:0,l:'11', role:'LW'},  // Sol Kanat
                    {r:5,c:4,l:'7', role:'RW'}    // Sağ Kanat
                ], 
                def: [
                    {r:0,c:2,l:'GK', role:'GK'}, 
                    {r:2,c:1,l:'4', role:'DEF'}, 
                    {r:2,c:2,l:'5', role:'DEF'}, 
                    {r:2,c:3,l:'3', role:'DEF'}
                ] 
            }
        ];
        let gameState = { phase: 'INIT', players: [], ballOwnerId: null, selectedUnit: null, moves: { atk: null, def: null } };

        function selectScen(i, e) { scenIdx=i; }

        function startGame() {
            const s = SCENARIOS[scenIdx];
            gameState.players = [];
            // Role bilgisini de ekliyoruz
            s.atk.forEach((p,i)=>gameState.players.push({id:`a${i}`, team:'atk', r:p.r, c:p.c, label:p.l, role:p.role}));
            s.def.forEach((p,i)=>gameState.players.push({id:`d${i}`, team:'def', r:p.r, c:p.c, label:p.l, role:p.role}));
            
            // Topu 10 Numaraya ver (daha mantıklı başlangıç)
            const playmaker = gameState.players.find(x=>x.role==='10');
            gameState.ballOwnerId = playmaker ? playmaker.id : gameState.players[0].id;
            
            gameState.phase = 'ATTACK_PLAN';
            sendData({ type: 'START', state: gameState });
            hide('scenario-screen'); 
            render(); updateUI();
        }

        function showWait(m) { el('wait-msg').innerText = m; show('wait-screen'); }
        function hideWait() { hide('wait-screen'); }

        function updateUI() {
            const s = el('status-text');
            // Şut butonu kontrolü
            checkStrikerShot();
            
            // GK Tahmin Modu Kontrolü
            if(myRole === 'def' && gameState.moves.atk && gameState.moves.atk.type === 'SHOT' && !gameState.moves.def) {
                // Hücum şut çekti, Savunma köşe seçmeli
                el('shot-title').innerText = "⚠️ KALEYE ŞUT! ⚠️";
                el('shot-desc').innerText = "Kurtarmak için bir köşe seç!";
                show('shot-screen');
                return;
            }

            if(gameState.phase === 'ATTACK_PLAN') {
                if(myRole === 'atk') { s.innerText = "HÜCUM PLANI"; s.style.color = "#fbbf24"; }
                else { s.innerText = "RAKİP HÜCUMDA"; s.style.color = "#fff"; showWait("Rakip düşünüyor..."); }
            } 
            else if(gameState.phase === 'DEFENSE_PLAN' || gameState.phase === 'WAIT_DEF') {
                if(gameState.phase === 'WAIT_DEF') gameState.phase = 'DEFENSE_PLAN';
                if(myRole === 'def') { s.innerText = "SAVUNMA PLANI"; s.style.color = "#60a5fa"; }
                else { s.innerText = "RAKİP SAVUNMADA"; s.style.color = "#fff"; showWait("Rakip hamle yapıyor..."); }
            }
        }

        // --- ŞUT MEKANİĞİ ---
        function checkStrikerShot() {
            el('btn-shoot-trigger').classList.remove('visible');
            if(myRole !== 'atk' || gameState.phase !== 'ATTACK_PLAN') return;

            const st = gameState.players.find(x => x.role === 'ST');
            if(!st || st.id !== gameState.ballOwnerId) return;

            // Önündeki 2 blok boş mu?
            const r1 = gameState.players.find(x => x.r === st.r-1 && x.c === st.c);
            const r2 = gameState.players.find(x => x.r === st.r-2 && x.c === st.c);

            // Eğer önü boşsa ve kaleye belli bir mesafedeyse (örn: r <= 4)
            if(!r1 && !r2 && st.r <= 5) {
                el('btn-shoot-trigger').classList.add('visible');
            }
        }

        function openShotMenu() {
            el('shot-title').innerText = "ŞUT ÇEK!";
            el('shot-desc').innerText = "Topu hangi köşeye göndereceksin?";
            show('shot-screen');
        }

        function confirmShot(side) {
            hide('shot-screen');
            if(myRole === 'atk') {
                // Hücum şutu çekti (Side: L veya R)
                gameState.moves.atk = { type: 'SHOT', side: side, actorId: gameState.ballOwnerId };
                commitMove();
            } else {
                // Savunma (Kaleci) köşeyi seçti
                gameState.moves.def = { type: 'SAVE', side: side, actorId: 'GK' }; // GK ID'si dinamik bulunabilir ama basit tuttum
                commitMove();
            }
        }

        // --- RENDER ---
        const pitch = el('pitch');
        function render() {
            pitch.innerHTML = '';
            for(let r=0; r<ROWS; r++) {
                for(let c=0; c<COLS; c++) {
                    const d = document.createElement('div'); d.className = 'cell'; d.dataset.r = r; d.dataset.c = c;
                    const p = gameState.players.find(x=>x.r===r && x.c===c);
                    
                    if(p) {
                        // Rol etiketi ile token oluştur
                        const t = document.createElement('div'); t.className = `token ${p.team}`; 
                        t.innerHTML = `<span>${p.label}</span><span class="role-tag">${p.role}</span>`;
                        
                        if(p.id===gameState.ballOwnerId) { t.innerHTML += `<div class="ball"></div>`; t.style.borderColor = "#fbbf24"; t.style.zIndex = "10"; }
                        if(gameState.selectedUnit===p.id) t.classList.add('selected');
                        d.appendChild(t);
                    }
                    
                    // --- HÜCUM GÖRSELLERİ (ÖZELLEŞTİRİLMİŞ) ---
                    if(myRole==='atk' && gameState.phase==='ATTACK_PLAN' && gameState.selectedUnit) {
                        const activeUnit = gameState.players.find(x=>x.id === gameState.selectedUnit);
                        if(activeUnit) {
                            const dist = Math.max(Math.abs(activeUnit.r-r), Math.abs(activeUnit.c-c));
                            const hasBall = (activeUnit.id === gameState.ballOwnerId);

                            // ROL ÖZELLİKLERİ
                            let moveRange = 1;
                            let passRange = 2; // Default

                            if(activeUnit.role === 'LW' || activeUnit.role === 'RW') moveRange = 2; // Kanatlar Hızlı
                            if(activeUnit.role === '10') passRange = 99; // 10 Numara Global Pas

                            // Hareket
                            if(!p && dist <= moveRange) addMark(d,'m-move');
                            
                            // Pas
                            if(hasBall && p && p.team==='atk' && p.id!==activeUnit.id && dist <= passRange) {
                                addMark(d,'m-pass');
                            }
                        }
                    }

                    // Savunma (Aynı)
                    if(myRole==='def' && gameState.phase==='DEFENSE_PLAN' && gameState.selectedUnit) {
                        const df = gameState.players.find(x=>x.id===gameState.selectedUnit);
                        if(df && df.team==='def' && Math.abs(df.r-r)<=1 && Math.abs(df.c-c)<=1) addMark(d,'m-block');
                    }

                    d.onclick = () => handleInp(r,c,p);
                    pitch.appendChild(d);
                }
            }
        }
        
        function addMark(e, t) { const m=document.createElement('div'); m.className=`marker ${t}`; e.appendChild(m); }

        function handleInp(r, c, p) {
            if((myRole==='atk' && gameState.phase!=='ATTACK_PLAN') || (myRole==='def' && gameState.phase!=='DEFENSE_PLAN')) return;
            
            if(myRole==='atk') {
                if(gameState.selectedUnit) {
                    const actor = gameState.players.find(x=>x.id === gameState.selectedUnit);
                    const isBallOwner = (actor.id === gameState.ballOwnerId);
                    const dist = Math.max(Math.abs(actor.r - r), Math.abs(actor.c - c));

                    // ROL LİMİTLERİ
                    let maxPass = (actor.role === '10') ? 99 : 2;
                    let maxMove = (actor.role === 'LW' || actor.role === 'RW') ? 2 : 1;

                    // PAS
                    if (isBallOwner && p && p.team === 'atk' && p.id !== actor.id && dist <= maxPass) {
                        gameState.moves.atk = {type:'PASS', r:r, c:c, targetId:p.id, actorId:actor.id}; 
                        commitMove(); return;
                    }
                    // SEÇİM DEĞİŞTİR
                    if (p && p.team === 'atk' && p.id !== actor.id) {
                        gameState.selectedUnit = p.id; render(); return;
                    }
                    // HAREKET
                    if (!p && dist <= maxMove) {
                        gameState.moves.atk = {type:'MOVE', r:r, c:c, actorId:actor.id}; 
                        commitMove(); return;
                    }
                }
                if(p && p.team === 'atk') { gameState.selectedUnit = p.id; render(); }

            } else {
                // Savunma
                if(p && p.team==='def') { gameState.selectedUnit=p.id; render(); return; }
                if(gameState.selectedUnit) {
                    const df = gameState.players.find(x=>x.id===gameState.selectedUnit);
                    if(Math.abs(df.r-r)<=1 && Math.abs(df.c-c)<=1) { 
                        gameState.moves.def={r:r, c:c, actorId:df.id}; commitMove(); 
                    }
                }
            }
        }

        function commitMove() {
            if(myRole==='atk') { gameState.phase='WAIT_DEF'; sendData({ type: 'MOVED', state: gameState }); updateUI(); }
            else { gameState.phase='RESOLVE'; sendData({ type: 'MOVED', state: gameState }); updateUI(); }
        }

        // --- SONUÇ ÇÖZÜMLEME ---
        function resolveTurn() {
            const am = gameState.moves.atk; const dm = gameState.moves.def;
            if(!am || !dm) return;

            let t="", d="", msg="";
            let gameOver = false;

            // ÖZEL DURUM: ŞUT ve KURTARIŞ
            if(am.type === 'SHOT') {
                if(dm.type === 'SAVE') {
                    if(am.side !== dm.side) {
                        t = "GOOOOOOOOL!"; d = "Kaleci ters köşe!"; gameOver = true;
                    } else {
                        t = "KURTARDI!"; d = "Kaleci köşeyi bildi! Top savunmaya geçti.";
                        // Topu kaleciye verelim
                        const gk = gameState.players.find(x=>x.role==='GK');
                        if(gk) gameState.ballOwnerId = gk.id;
                    }
                    sendData({ type: 'RESULT', state: gameState, title: t, desc: d });
                    showResult(t, d); render();
                    return;
                }
            }

            // NORMAL HAREKET ÇÖZÜMLEMESİ
            const ad = gameState.players.find(x=>x.id===dm.actorId);
            const defStartR = ad.r; const defStartC = ad.c;
            ad.r = dm.r; ad.c = dm.c; 

            const attacker = gameState.players.find(x=>x.id === am.actorId);
            const atkStartR = attacker.r; const atkStartC = attacker.c;
            const blocked = (am.r===dm.r && am.c===dm.c);
            
            const ballOwner = gameState.players.find(x=>x.id === gameState.ballOwnerId);
            const attackerHasBall = (attacker.id === ballOwner.id);

            if(blocked) {
                if(attackerHasBall) { t="TOP KAYBI!"; d="Savunma topu kaptı!"; }
                else { t="BLOKAJ!"; d="Topsuz koşu engellendi."; attacker.r = atkStartR; attacker.c = atkStartC; }
            } else {
                if(am.type==='PASS') { 
                    gameState.ballOwnerId=am.targetId; t="PAS BAŞARILI"; d="Atak devam ediyor."; 
                } else { 
                    attacker.r = am.r; attacker.c = am.c; 
                    if(attackerHasBall) {
                        if(am.r===0) { t="GOOOOOOOOL!"; d="Çizgiyi geçtin!"; gameOver = true; }
                        else { t="ÇALIM / KOŞU"; d="Boş alandasın."; }
                    } else { t="POZİSYON ALDI"; d="Topsuz koşu."; }
                }
            }
            
            const sAtk = gameState.players.find(x=>x.team==='atk' && x.r===dm.r && x.c===dm.c && x.id!==am.actorId);
            if(sAtk) { sAtk.r=defStartR; sAtk.c=defStartC; msg="<br>(Çarpışma!)"; d+=msg; }

            sendData({ type: 'RESULT', state: gameState, title: t, desc: d });
            showResult(t, d); render();
        }

        function showResult(t, d) {
            el('result-title').innerText = t; el('result-desc').innerHTML = d;
            const btn = el('result-btn');
            const isOver = t.includes("GOL") || t.includes("TOP KAYBI");
            if(isOver) { btn.innerText = "YENİ MAÇ"; btn.className = "btn btn-danger"; btn.onclick = () => location.reload(); }
            else { btn.innerText = "DEVAM ET"; btn.className = "btn"; btn.onclick = nextTurn; }
            hideWait(); show('result-screen');
        }

        function nextTurn() {
            if(!isHost) { showWait("Ev sahibi bekleniyor..."); hide('result-screen'); return; }
            gameState.phase = 'ATTACK_PLAN'; gameState.selectedUnit = null; gameState.moves = {atk:null, def:null};
            sendData({ type: 'NEXT', state: gameState });
            hide('result-screen'); render(); updateUI();
        }
    </script>
</body>
</html>
